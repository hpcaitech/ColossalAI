name: Test Example on Schedule
on:
  # run at 00:00 of every Sunday(singapore time) so here is UTC time Saturday 16:00
  schedule:
    - cron:  '0 16 * * 6'
  workflow_dispatch:

jobs:
  # This is for all files' weekly check. Specifically, this job is to find all the directories.
  matrix_preparation:
    if: github.repository == 'hpcaitech/ColossalAI'
    name: Prepare matrix for weekly check
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.setup-matrix.outputs.matrix }}
    steps:
    - name: ðŸ“š Checkout
      uses: actions/checkout@v3

    - name: setup matrix
      id: setup-matrix
      run: |
        res=`python .github/workflows/scripts/example_checks/check_example_weekly.py`
        all_loc=$( IFS=',' ; echo "${res[*]}" )
        echo "Found the examples: $all_loc"
        echo "matrix={\"directory\":$(echo "$all_loc")}" >> $GITHUB_OUTPUT
  
  prepare_cache_for_hf:
    name: Prepare huggingface cache for example test
    if: github.repository == 'hpcaitech/ColossalAI'
    runs-on: [self-hosted, gpu]
    container:
      image: hpcaitech/pytorch-cuda:1.12.0-11.3.0
      options: --rm
    timeout-minutes: 5
    defaults:
      run:
        shell: bash
    concurrency:
      group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}-repare-cache
      cancel-in-progress: true
    steps:
      - name: Prepare bert weights to cache_dir
        run: |
          pip install transformers
          export model_name="bert-base-uncased"
          export cache_dir="/home/lcsoftware/gitact/actions-runner/_work/_temp/_github_home/hf_cache"
          python -c "from transformers import AutoConfig, BertForSequenceClassification; cfg = AutoConfig.from_pretrained(\"${model_name}\", num_labels=3); BertForSequenceClassification.from_pretrained(\"${model_name}\", config=cfg, cache_dir=\"${cache_dir}\")"
  
  weekly_check:
    if: github.repository == 'hpcaitech/ColossalAI'
    name: Weekly check all examples
    needs: matrix_preparation
    runs-on: [self-hosted, gpu]
    strategy:
      fail-fast: false
      matrix: ${{fromJson(needs.matrix_preparation.outputs.matrix)}}
    container:
      image: hpcaitech/pytorch-cuda:2.0.0-11.7.0
    timeout-minutes: 10
    steps:
      - name: ðŸ“š Checkout
        uses: actions/checkout@v3

      - name: Install Colossal-AI
        run: |
          CUDA_EXT=1 pip install -v .
          
      - name: Traverse all files
        run: |
          example_dir=${{ matrix.directory }}
          echo "Testing ${example_dir} now"
          if [[ $example_dir == *language/bert* ]]; then
            echo "restore Bert weights to ${PWD}/examples/${example_dir}"
            cp -p -r /home/lcsoftware/gitact/actions-runner/_work/_temp/_github_home/hf_cache "${PWD}/examples/${example_dir}"
            ls -A ${PWD}/examples/${example_dir} | grep *bert-base*
          fi
          cd "${PWD}/examples/${example_dir}"
          bash test_ci.sh
        env:
          NCCL_SHM_DISABLE: 1

      - name: Notify Lark
        id: message-preparation
        if: ${{ failure() }}
        run: |
          url=$SERVER_URL/$REPO/actions/runs/$RUN_ID
          msg="Example tests failed for $EXAMPLE_DIR, please visit $url for details"
          echo $msg
          python .github/workflows/scripts/send_message_to_lark.py -m "$msg" -u $WEBHOOK_URL
        env:
          SERVER_URL: ${{github.server_url }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
          WEBHOOK_URL: ${{ secrets.LARK_NOTIFICATION_WEBHOOK_URL }}
          EXAMPLE_DIR: ${{ matrix.directory }}
